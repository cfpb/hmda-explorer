<!DOCTYPE html>

<html>
<head>
  <title>home.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>home.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>$(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
<span class="hljs-pi">
  'use strict'</span>;

  <span class="hljs-keyword">var</span> map,
      video;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Circle nav on the homepage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">'.homepage .hero a'</span>).on( <span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( ev )</span></span>{

    <span class="hljs-keyword">var</span> target = $( <span class="hljs-keyword">this</span> ).attr(<span class="hljs-string">'href'</span>);
    ev.preventDefault();
    $(<span class="hljs-string">'html, body'</span>).animate({ scrollTop: $( target ).position().top }, <span class="hljs-number">200</span>);

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Change the underlying data link for graph when a different radio is selected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">'#map_radios'</span>).on(<span class="hljs-string">'change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( ev )</span></span>{
    <span class="hljs-keyword">var</span> radio = $(<span class="hljs-keyword">this</span>).find(<span class="hljs-string">'input[type=radio]:checked'</span>);
    <span class="hljs-keyword">if</span>( radio.val() === <span class="hljs-string">'r'</span> ){
      $( <span class="hljs-string">'#map-title'</span> ).find(<span class="hljs-string">'a.underlying'</span>).attr(<span class="hljs-string">'href'</span>, <span class="hljs-string">'explore#!/as_of_year=2013,2012,2011&amp;property_type=1,2&amp;owner_occupancy=1&amp;action_taken=1&amp;loan_purpose=3&amp;lien_status=1&amp;select=state_name,county_name,as_of_year,count&amp;section=summary'</span>);
    } <span class="hljs-keyword">else</span> {
      $( <span class="hljs-string">'#map-title'</span> ).find(<span class="hljs-string">'a.underlying'</span>).attr(<span class="hljs-string">'href'</span>, <span class="hljs-string">'explore#!/as_of_year=2013,2012,2011&amp;property_type=1,2&amp;owner_occupancy=1&amp;action_taken=1&amp;loan_purpose=1&amp;lien_status=1&amp;select=state_name,county_name,as_of_year,count&amp;section=summary'</span>);
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Map toggling on the homepage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  map = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

    <span class="hljs-keyword">var</span> map = {};

    map.base = L.mapbox.map(<span class="hljs-string">'map'</span>, <span class="hljs-string">'cfpb.fxomkj4i'</span>).setView([<span class="hljs-number">39.54</span>, -<span class="hljs-number">97.87</span>], <span class="hljs-number">4</span>);
    
    map.layers = {
      r2013: L.mapbox.tileLayer(<span class="hljs-string">'cfpb.6uwyiudi'</span>),
      r2012: L.mapbox.tileLayer(<span class="hljs-string">'cfpb.2yugzaor'</span>),
      p2013: L.mapbox.tileLayer(<span class="hljs-string">'cfpb.z2z3q5mi'</span>),
      p2012: L.mapbox.tileLayer(<span class="hljs-string">'cfpb.pbjoflxr'</span>)
    };

    map.layersLoaded = <span class="hljs-number">0</span>;
    

    map.firstLoad = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      
      <span class="hljs-keyword">var</span> selectedLayer = map.getSelectedLayer(),
          otherLayers = _.omit(  map.layers, selectedLayer );
      
      map.addAndHide( map.layers[ selectedLayer ] );

      $( <span class="hljs-built_in">document</span> ).one(<span class="hljs-string">'scroll'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( e )</span></span>{
        _( otherLayers ).forEach( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( layer )</span></span>{
          map.addAndHide( layer );
        });

        map.layersLoaded = <span class="hljs-number">1</span>;
      });

    };
    
    map.addAndHide = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(layer)</span> </span>{
      layer.addTo( map.base );</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>IE and MapBox don’t completely get along so we only add snazzy
fade-in effects with non-IE browsers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
      <span class="hljs-keyword">if</span> ( !$(<span class="hljs-string">'body'</span>).hasClass(<span class="hljs-string">'lt-ie9'</span>) ) {
        map.base.addLayer( layer );
        $( layer._tileContainer ).hide();
      }

    };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>In order to get a nice fade when we toggle between layers, 
add them before they are needed, but don’t add the currently
hidden ones until a scroll event is fired.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    map.addLayers = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span> ( map.layersLoaded ){
        _( map.layers ).forEach( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( layer )</span></span>{
          addAndHide( layer );
        });
      }<span class="hljs-keyword">else</span>{
        map.firstLoad();
      }

    };


     
    map.showMap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-keyword">this</span>.addLayers();
      <span class="hljs-keyword">this</span>.showLayer();

      $(<span class="hljs-string">'#map-title'</span>).removeClass(<span class="hljs-string">'hidden'</span>);

      $(<span class="hljs-string">'#map .controls input'</span>).on( <span class="hljs-string">'change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( ev )</span></span>{
        $( <span class="hljs-keyword">this</span> ).parent().addClass(<span class="hljs-string">'selected'</span>).siblings().removeClass(<span class="hljs-string">'selected'</span>);
        map.showLayer();
      });

    };

    map.getSelectedLayer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-keyword">var</span> type = $(<span class="hljs-string">'#map .type input:checked'</span>).val(),
          year = $(<span class="hljs-string">'#map .year input:checked'</span>).val();
      <span class="hljs-keyword">return</span> type + year;

    };

    map.showLayer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-keyword">var</span> selectedLayer = map.getSelectedLayer(),
          otherLayers = _.omit( map.layers, selectedLayer );</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>IE and MapBox don’t completely get along so we only add snazzy
fade-in effects with non-IE browsers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ( !$(<span class="hljs-string">'body'</span>).hasClass(<span class="hljs-string">'lt-ie9'</span>) ) {

        $( map.layers[ selectedLayer ]._tileContainer ).fadeIn();

        _( otherLayers ).forEach( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( layer )</span></span>{
          $( layer._tileContainer ).fadeOut( <span class="hljs-number">800</span> );
        });

      } <span class="hljs-keyword">else</span> {

        map.base.addLayer( map.layers[ selectedLayer ] );

        _( otherLayers ).forEach( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( layer )</span></span>{
          map.base.removeLayer( layer );
        });

      }
      
    };

    map.fixLegend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-keyword">var</span> under30,
          over30;

      under30 = $(<span class="hljs-string">'#map .legend-labels li'</span>).first().html();
      $(<span class="hljs-string">'#map .legend-labels li'</span>).first().html( under30 + <span class="hljs-string">'&lt; -30%'</span> );

      over30 = $(<span class="hljs-string">'#map .legend-labels li:nth-last-child(2)'</span>).html();
      $(<span class="hljs-string">'#map .legend-labels li:nth-last-child(2)'</span>).html( over30.replace( <span class="hljs-string">'Over 30%'</span>, <span class="hljs-string">'&gt; 30%'</span> ) );

      $(<span class="hljs-string">'#map .my-legend .legend-title'</span>).html(<span class="hljs-string">'Percentage Change'</span>);

      $(<span class="hljs-string">'#map .my-legend .legend-source'</span>).hide();

    };

    map.init = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-keyword">this</span>.base.scrollWheelZoom.disable();

      map.showMap();
      $(<span class="hljs-string">'#map-title'</span>).removeClass(<span class="hljs-string">'hidden'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Ensure the correct layer is shown whenever the user zooms.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.base.on( <span class="hljs-string">'zoomend'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

        <span class="hljs-keyword">this</span>.showLayer();

      }.bind( <span class="hljs-keyword">this</span> ));</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Fix the darn legend.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.base.on( <span class="hljs-string">'ready'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

        map.fixLegend();

      }.bind( <span class="hljs-keyword">this</span> ));

      $(<span class="hljs-string">'#map .help'</span>).tooltip({
        placement: <span class="hljs-string">'right'</span>,
        container: <span class="hljs-string">'body'</span>,
        title: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTooltipTitle</span><span class="hljs-params">()</span></span>{
          <span class="hljs-keyword">return</span> $( <span class="hljs-keyword">this</span> ).next(<span class="hljs-string">'.help-text'</span>).html();
        }
      }).on(<span class="hljs-string">'shown.bs.tooltip'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        $(<span class="hljs-string">'.tooltip'</span>).css({
          <span class="hljs-string">'margin-left'</span>: <span class="hljs-string">'15px'</span>,
          <span class="hljs-string">'margin-top'</span>: <span class="hljs-string">'6px'</span>,
          <span class="hljs-string">'width'</span>: <span class="hljs-string">'250px'</span>
        });
      }).on(<span class="hljs-string">'hide.bs.tooltip'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        $(<span class="hljs-string">'.tooltip'</span>).css({
          <span class="hljs-string">'margin-left'</span>: <span class="hljs-string">'0'</span>,
          <span class="hljs-string">'margin-top'</span>: <span class="hljs-string">'0'</span>,
          <span class="hljs-string">'width'</span>: <span class="hljs-string">'auto'</span>
        });
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>IE8 doesn’t hear the map ‘ready’ event so here’s a setinterval hack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ( $(<span class="hljs-string">'body'</span>).hasClass(<span class="hljs-string">'lt-ie9'</span>) ) {
        <span class="hljs-keyword">var</span> checkForLegend = setInterval( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
          <span class="hljs-keyword">if</span> ( $(<span class="hljs-string">'#map .my-legend .legend-source'</span>).length ) {
            map.fixLegend();
            clearInterval( checkForLegend );
          }
        }, <span class="hljs-number">1000</span>);
      }

    };

    map.init();

  })();</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Methods to open and close the youtube video overlay on the homepage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  video = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

    <span class="hljs-keyword">var</span> $vid = $(<span class="hljs-string">'#youtube'</span>),
        $embed = $(<span class="hljs-string">'&lt;iframe width="100%" height="100%" src="//www.youtube.com/embed/wR9Tsdqgmuk?rel=0&amp;version=3&amp;enablejsapi=1&amp;autoplay=1" frameborder="0" allowfullscreen&gt;&lt;/iframe&gt;'</span>),
        $exit = $(<span class="hljs-string">'#youtube .exit'</span>),
        pos = $(<span class="hljs-string">'.video'</span>).position().top + ( $(<span class="hljs-string">'section.video'</span>).height() / <span class="hljs-number">2</span> );

    <span class="hljs-keyword">return</span> {

      isOpen: <span class="hljs-literal">false</span>,

      init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

      },

      open: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        $vid.css( <span class="hljs-string">'top'</span>, pos + <span class="hljs-string">'px'</span> )
            .removeClass(<span class="hljs-string">'hidden'</span>)
            .animate({ <span class="hljs-string">'height'</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-string">'margin-top'</span>: -pos + <span class="hljs-string">'px'</span> }, <span class="hljs-number">300</span>, <span class="hljs-string">'swing'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
              setTimeout( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
                $vid.append( $embed );
                $exit.show();
                <span class="hljs-keyword">if</span>( onYouTubeIframeAPIReady() ){
                  onYouTubeIframeAPIReady();
                }
              }, <span class="hljs-number">500</span> );
            });
        $embed.css( <span class="hljs-string">'height'</span>, $(<span class="hljs-built_in">window</span>).height() - <span class="hljs-number">60</span> + <span class="hljs-string">'px'</span>)
              .css( <span class="hljs-string">'width'</span>, $(<span class="hljs-built_in">window</span>).width() - <span class="hljs-number">60</span> + <span class="hljs-string">'px'</span>);
        <span class="hljs-keyword">this</span>.isOpen = <span class="hljs-literal">true</span>;
      },

      close: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        $embed.remove();
        $exit.hide();
        $vid.addClass(<span class="hljs-string">'closing'</span>);
        setTimeout( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
          $vid.css({ <span class="hljs-string">'height'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'margin-top'</span>: <span class="hljs-number">0</span> }).addClass(<span class="hljs-string">'hidden'</span>).removeClass(<span class="hljs-string">'closing'</span>);
        }, <span class="hljs-number">500</span> );
        <span class="hljs-keyword">this</span>.isOpen = <span class="hljs-literal">false</span>;
      }

    };
  })();</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Remove the video embed for now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  video.init();</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Video overlay.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">'a.launch-youtube'</span>).on( <span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( ev )</span></span>{

    ev.preventDefault();
    video.open();

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Autoplay video if requested.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">window</span>.location.hash &amp;&amp; <span class="hljs-built_in">window</span>.location.hash === <span class="hljs-string">'#video'</span> ) {
    video.open();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Close video overlay</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $( <span class="hljs-built_in">document</span> ).on( <span class="hljs-string">'keyup'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( ev )</span> </span>{

    <span class="hljs-keyword">if</span> ( ev.which === <span class="hljs-number">27</span> ) {
      ev.preventDefault();
      video.close();
    }

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Close video overlay</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $( <span class="hljs-string">'section.video .exit, #youtube'</span> ).on( <span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( ev )</span> </span>{

      ev.preventDefault();

      <span class="hljs-keyword">if</span> ( video.isOpen ) {
        video.close();
      }

  });

});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
