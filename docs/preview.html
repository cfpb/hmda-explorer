<!DOCTYPE html>

<html>
<head>
  <title>preview.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="dom.html">
                dom.js
              </a>
            
              
              <a class="source" href="form.html">
                form.js
              </a>
            
              
              <a class="source" href="ie8.html">
                ie8.js
              </a>
            
              
              <a class="source" href="observer.html">
                observer.js
              </a>
            
              
              <a class="source" href="preview.html">
                preview.js
              </a>
            
              
              <a class="source" href="query.html">
                query.js
              </a>
            
              
              <a class="source" href="summary-table.html">
                summary-table.js
              </a>
            
              
              <a class="source" href="utils.html">
                utils.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>preview.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> PDP = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( pdp )</span> </span>{
<span class="hljs-pi">
  'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="the-preview">The Preview</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The preview is a table of records the user can inspect before downloading the data slice.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> preview = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Cache a reference to the preview table’s jQuery object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.$el = $(<span class="hljs-string">'#preview'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Cache a reference to the download size messaging section.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.$downloadSize = $(<span class="hljs-string">'.filesize'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Whether or not the preview is currently updating.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview._updating = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Object for handling NLW stuff.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.nlw = {

    $el: $(<span class="hljs-string">'.nlw'</span>),
    count: <span class="hljs-string">'many'</span>

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>The <code>startLoading</code> method adds a class to the preview section’s element so we can
visualize the loading of content.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.startLoading = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">this</span>.$el.addClass(<span class="hljs-string">'loading'</span>);
    <span class="hljs-keyword">this</span>.nlw.$el.addClass(<span class="hljs-string">'loading'</span>);
    <span class="hljs-keyword">this</span>.nlw.$el.find(<span class="hljs-string">'.calculating'</span>).show();
    <span class="hljs-keyword">this</span>.nlw.$el.find(<span class="hljs-string">'.count'</span>).hide();
    preview.$downloadSize.addClass(<span class="hljs-string">'hidden'</span>);

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The <code>stopLoading</code> method removes the preview section’s loading class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.stopLoading = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">this</span>.$el.removeClass(<span class="hljs-string">'loading'</span>);
    <span class="hljs-keyword">this</span>.nlw.$el.removeClass(<span class="hljs-string">'loading'</span>);
    <span class="hljs-keyword">this</span>.nlw.$el.find(<span class="hljs-string">'.calculating'</span>).hide();
    <span class="hljs-keyword">this</span>.nlw.$el.find(<span class="hljs-string">'.count'</span>).show();

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Show the preview table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.showTable = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">this</span>.$el.slideDown( <span class="hljs-number">250</span> );
    <span class="hljs-keyword">this</span>.enableTable();
    $(<span class="hljs-string">'.preview'</span>).removeClass(<span class="hljs-string">'closed'</span>);

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Hide the preview table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.hideTable = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">this</span>.$el.slideUp( <span class="hljs-number">250</span> );
    $(<span class="hljs-string">'.preview'</span>).addClass(<span class="hljs-string">'closed'</span>);

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Enable the preview table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.enableTable = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    $(<span class="hljs-string">'.preview .title'</span>).removeClass(<span class="hljs-string">'disabled'</span>);
    <span class="hljs-keyword">this</span>.$el.find(<span class="hljs-string">'th, td'</span>).tooltip({ container: <span class="hljs-string">'body'</span>, html: <span class="hljs-literal">true</span> });
    $(<span class="hljs-string">'.msg.preview-table'</span>).removeClass(<span class="hljs-string">'error'</span>).html(<span class="hljs-string">''</span>);

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Disable the preview table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.disableTable = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">var</span> $title = $(<span class="hljs-string">'.preview .title'</span>);

    $title.addClass(<span class="hljs-string">'disabled'</span>);

    $(<span class="hljs-string">'.msg.preview-table'</span>).addClass(<span class="hljs-string">'error'</span>).html(<span class="hljs-string">'&lt;i class="icon-error-alt"&gt;&lt;/i&gt; There was a problem connecting to the API. Reload the page and if this problem persists, &lt;a href="http://www.consumerfinance.gov/contact-us/"&gt;contact us&lt;/a&gt;.'</span>);

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>This is used to ensure only the latest AJAX requested is acted upon.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview._lastRequestTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>The <code>_fetchPreviewJSON</code> method returns a promise of JSON</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview._fetchPreviewJSON = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> url = pdp.query.generateApiUrl( <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span> ) + <span class="hljs-string">'&amp;$limit=100'</span>,
        promise = pdp.utils.getJSON( url );

    preview._lastRequestTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    promise._timestamp = preview._lastRequestTime;

    <span class="hljs-keyword">return</span> promise;

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>The <code>update</code> method updates the preview section.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.update = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">var</span> promise = <span class="hljs-keyword">this</span>._fetchPreviewJSON(),
        $downloadButton = $(<span class="hljs-string">'#download .action'</span>),
        check,
        aborted;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Has the request been aborted?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    aborted = <span class="hljs-literal">false</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_abort</span><span class="hljs-params">( data, textStatus )</span> </span>{

      aborted = <span class="hljs-literal">true</span>;
      preview.nlw.count = <span class="hljs-string">'probably a whole lot of'</span>;
      preview.updateNLW();
      preview.stopLoading();
      preview.disableTable();
      pdp.form.disableField( $downloadButton );

    }

    preview.startLoading();
    preview.enableTable();
    pdp.form.enableField( $downloadButton );
    preview.updateNLW();

    promise.done( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span> </span>{

      <span class="hljs-keyword">if</span> ( promise._timestamp &lt; preview._lastRequestTime || aborted ) {
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">if</span> ( data.total &lt;= <span class="hljs-number">0</span> ) {
        pdp.form.disableField( $downloadButton );
      }

      preview.nlw.count = data.total;
      preview.updateTable( data.results );
      preview.updateNLW();
      preview.updateDownloadSize();
      preview.stopLoading();

    });

    promise.fail( _abort );

    check = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">if</span> ( promise.state() !== <span class="hljs-string">'resolved'</span> &amp;&amp; promise._timestamp == preview._lastRequestTime ) {
        _abort( <span class="hljs-literal">null</span>, <span class="hljs-string">'time out'</span> );
      }
    }, pdp.query.secondsToWait * <span class="hljs-number">1000</span> );

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>The <code>updateNLW</code> method updates the natural language sentence above the preview table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.updateNLW = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>If there are year(s) selected use ‘em, otherwise use all years.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> years = <span class="hljs-keyword">typeof</span> pdp.query.params.as_of_year !== <span class="hljs-string">'undefined'</span> &amp;&amp; !_.isEmpty( pdp.query.params.as_of_year.values ) ? _.clone( pdp.query.params.as_of_year.values ).sort() : [<span class="hljs-number">2007</span>, <span class="hljs-number">2008</span>, <span class="hljs-number">2009</span>, <span class="hljs-number">2010</span>, <span class="hljs-number">2011</span>, <span class="hljs-number">2012</span>, <span class="hljs-number">2013</span>],
        countFormatted = pdp.utils.commify( preview.nlw.count ),
        filters,
        areConsecutive;

    <span class="hljs-keyword">switch</span>( $(<span class="hljs-string">'#suggested'</span>).val() ) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'common'</span>:
        filters = <span class="hljs-string">' for first-lien, owner-occupied, 1-4 family homes'</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'originations'</span>:
        filters = <span class="hljs-string">' with originated mortgages'</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'default'</span>:
        filters = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'all'</span>:
        filters = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        filters = <span class="hljs-string">' with the above selected filters'</span>;
    }

    <span class="hljs-keyword">if</span> ( years.length &gt; <span class="hljs-number">1</span> ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Are the selected years consecutive?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      areConsecutive = _.every( years, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( val, i, arr )</span></span>{
        <span class="hljs-keyword">if</span> ( i &gt; <span class="hljs-number">0</span> ) {
          <span class="hljs-keyword">return</span> val == +arr[ i - <span class="hljs-number">1</span> ] + <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If they’re consecutive, display the first and last with a dash in the middle.
Otherwise, join with commas for a list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      years = areConsecutive ? years[<span class="hljs-number">0</span>] + <span class="hljs-string">' - '</span> + _.last( years ) : years.join(<span class="hljs-string">', '</span>);

    }

    preview.nlw.$el.find(<span class="hljs-string">'.count'</span>).html( countFormatted );
    preview.nlw.$el.find(<span class="hljs-string">'.years'</span>).html( years );
    preview.nlw.$el.find(<span class="hljs-string">'.filter-selection'</span>).html( filters );

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>The <code>updateDownloadSize</code> method estimates how large the downloaded file will be and 
updates the text under the download button.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.updateDownloadSize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">var</span> count = preview.nlw.count,
        multiplier = pdp.query.codes ? <span class="hljs-number">724.88</span> : <span class="hljs-number">684.88</span>,
        filesize;

    <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">isNaN</span>( count ) || !count ) {
      preview.$downloadSize.addClass(<span class="hljs-string">'hidden'</span>);
      <span class="hljs-keyword">return</span>;
    }

    preview.$downloadSize.removeClass(<span class="hljs-string">'hidden'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>The multiplier numbers above is the result of averaging the filesizes of a random 
sample of file downloads.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    filesize = pdp.utils.getPrettyFilesize( count * multiplier );

    preview.$downloadSize.find(<span class="hljs-string">'.bytes'</span>).html( filesize );

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>The <code>updateTable</code> method updates the preview table.
@data = JS object of all the data to populate the HTML table with.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  preview.updateTable = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>We don’t want to show every dimension from the API in the preview table so we 
specify which ones to show here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> _fields = {
            action_taken_name: <span class="hljs-string">'Action taken'</span>,
            agency_name: <span class="hljs-string">'Agency name'</span>,
            applicant_ethnicity_name: <span class="hljs-string">'Applicant ethnicity'</span>,
            applicant_race_name_1: <span class="hljs-string">'Applicant race'</span>,
            applicant_sex_name: <span class="hljs-string">'Applicant sex'</span>,
            census_tract_number: <span class="hljs-string">'Census tract'</span>,
            co_applicant_ethnicity_name: <span class="hljs-string">'Co-applicant ethnicity'</span>,
            co_applicant_race_name_1: <span class="hljs-string">'Co-applicant race'</span>,
            co_applicant_sex_name: <span class="hljs-string">'Co-applicant sex'</span>,
            county_name: <span class="hljs-string">'County'</span>,
            denial_reason_name_1: <span class="hljs-string">'Denial reason'</span>,
            edit_status_name: <span class="hljs-string">'Status'</span>,
            hoepa_status_name: <span class="hljs-string">'HOEPA status'</span>,
            lien_status_name: <span class="hljs-string">'Lien status'</span>,
            loan_purpose_name: <span class="hljs-string">'Loan purpose'</span>,
            loan_type_name: <span class="hljs-string">'Loan type'</span>,
            msamd_name: <span class="hljs-string">'MSA'</span>,
            owner_occupancy_name: <span class="hljs-string">'Owner occupancy'</span>,
            preapproval_name: <span class="hljs-string">'Preapproval'</span>,
            property_type_name: <span class="hljs-string">'Property type'</span>,
            purchaser_type_name: <span class="hljs-string">'Purchaser type'</span>,
            respondent_id: <span class="hljs-string">'Respondent ID'</span>,
            sequence_number: <span class="hljs-string">'Sequence number'</span>,
            state_name: <span class="hljs-string">'State'</span>,
            as_of_year: <span class="hljs-string">'Year'</span>
          },
          _keys = _.keys( _fields ),
          _rows = [],
          _rowConstructor = {};

      _( _keys ).forEach( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( key )</span></span>{
        _rowConstructor[ key ] = <span class="hljs-string">'&lt;em&gt;N/A&lt;/em&gt;'</span>;
      });

      _( data ).forEach( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( row )</span></span>{

        <span class="hljs-keyword">var</span> _row = _.clone( _rowConstructor ),
            _flattenedRow = [];

        _( row ).forEach( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( entry, key )</span></span>{
          <span class="hljs-keyword">if</span> ( _.include( _keys, key ) ) {
            _row[ key ] = entry;
          }
        });

        _( _row ).forEach( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( entry )</span></span>{
          _flattenedRow.push( entry );
        });

        _rows.push( _flattenedRow );

      });

      preview.$el.TidyTable({</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>enableCheckbox: true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      }, {
        columnTitles: _.toArray( _fields ),
        columnValues: _rows
      });

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Export the public API.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pdp.preview = preview;

  <span class="hljs-keyword">return</span> pdp;

}( PDP || {} ));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
